<!DOCTYPE HTML>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>QoS por comunas de la Región Metropolitana</title>
    <script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
    <script src="js/d3.js"></script>
    <script src="js/svg.js"></script>
    <link rel="stylesheet" href="./css/mapa.css">
  </head>
  <body>
    <div id="tabs_selector">
      <button id="wifi" onclick="selectWifi()">WiFi</button>
      <button id="mobile" onclick="selectMobile()">Datos Móviles</button>
    </div>
    <div id="tab_content">
      <div id="company_selector">
        <div id="company_description" style="width: 100%"><h3>Compañías</h3></div>
        <div id="companies">
          <button id="all" onclick="particularIsp('all')">Mostrar todas</button>
        </div>
      </div>
      <div id="description" style="width: 100%">
        <p>Mostrando intensidad de señal por comuna en Región Metropolitana</p>
      </div>
      <div id="chart" style="width: 100%">
        <div id="map" style="float: left; width: 50%"></div>
        <div id="map_scale" style="float: left; width: 10%"></div>
        <div id="table" style="float: left; width: 40%; visibility: hidden">
          <h4 id="table_name">Comuna</h4>
          <p>Intensidad de señal por compañía</p>
          <div id="concrete_table"></div>
        </div>
      </div>
    </div>
    <script>
      // Read config
      let CONFIG = {};
      $.getJSON('./config.json', function (data){
        for(let datum of Object.entries(data)){
          CONFIG[datum[0]] = datum[1];
        }
      });
      let whole_data;
      let wifi = true;
      let mobile = false;
      let isp = "all";
      let data_wifi = "./res/ResultsQOSWiFi.csv";
      let data_mobile = "./res/ResultsQOSMobile.csv";
      let isp_wifi = d3.csv("./res/ISPWiFi.csv").then(data =>{
        return data;
      });
      let isp_mobile = d3.csv("./res/ISPMobile.csv").then(data =>{
        return data;
      });



      let isp_names = {
          "ENTEL CHILE S.A.":"Entel",
          "Manquehuenet":"Gtd",
          "TELEFONICA CHILE S.A.":"Movistar",
          "VTR BANDA ANCHA S.A.":"Vtr",
          "Telmex Servicios Empresariales S.A.":"Telmex",
          "Pacifico Cable SPA.":"Pacífico",
          "CLARO CHILE S.A.":"Claro",
          "Besthost Spa":"Besthost",
          "SITELCO SPA":"Sitelco",
          "WOM S.A.":"Wom",
          "73007":"Virgin",
          "73009":"Wom",
          "73001":"Entel",
          "73003":"Claro",
          "73002":"Movistar",
          "73008":"Vtr"
      }

      function selectWifi(){
        wifi = true;
        mobile = false;
        initialize();
      }

      function selectMobile(){
        wifi = false;
        mobile = true;
        initialize();
      }

      function initialize(){
        document.getElementById("companies")
                .innerHTML = `<button id="all" onClick="particularIsp('all')">Mostrar todas</button>`
        if (wifi){
          generateButtons(isp_wifi);
        }
        if (mobile){
          generateButtons(isp_mobile);
        }
        particularIsp("all");
      }

      function generateButtons(what){
        what.then(data => {
          let k = 0;
          data.forEach(function(d){
            console.log(k, d.isp, isp_names[d.isp]);
            document.getElementById("companies").innerHTML +=
                    `<button id="isp_${k}" onclick="particularIsp('${d.isp}')">${isp_names[d.isp]}</button>`
            k++;
          })
          //console.log(document.getElementById("companies").innerHTML)
        })
      }

      function particularIsp(selectedIsp){
        isp = selectedIsp;
        console.debug("ISP selected " + selectedIsp);
        if (wifi) {
          generateMap(data_wifi);
        }
        if (mobile) {
          generateMap(data_mobile);
        }
      }


      function selectIsp(isp, dataset){
        let temp = {};
        let comunas = [];
        if(isp==="all"){
          dataset.forEach(function(d){
              if(comunas.includes(d.comuna)){
                temp[d.comuna]["rtt"] += +d.avg_rtt * +d.count;
                temp[d.comuna]["jitter"] += +d.avg_jitter * +d.count;
                temp[d.comuna]["count"] += +d.count;
              } else {
                comunas.push(d.comuna);
                temp[d.comuna] = {
                  "rtt": +d.avg_rtt * +d.count,
                  "jitter": +d.avg_jitter * +d.count,
                  "count": +d.count,
                }
              }
            })
          for(let key in temp){
            temp[key]["rtt"] /= temp[key]["count"];
            temp[key]["jitter"] /= temp[key]["count"];
          }
        } else {
          dataset.forEach(function(d) {
            if (isp === d.isp) {
              temp[d.comuna] = {
                "rtt": +d.avg_rtt,
                "jitter": +d.avg_jitter,
              }
            }
          });
        }
        let data = [];
        for(let key in temp){
          data.push({
            "comuna": key,
            "rtt": temp[key]["rtt"],
            "jitter": temp[key]["jitter"],
          })
        }
        return data;
      }

      function generateMap(dataset_file){
        d3.select("#svg2").remove();
        document.getElementById("table").style.visibility = "hidden";
        let svg = d3.select("#map");
        let div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);
        d3.xml("./images/Comunas_de_Santiago_(plain).svg")
              .then(xml => {
                let svgMap = xml.documentElement;
                d3.select(svgMap)
                        .style("float", "left")
                        .attr("height", "100%")
                        .attr("width", "auto")
                        .on("mouseover", function(e){
                          let selected_comuna = e.target.id;
                          SVG(document.getElementById(selected_comuna)).front();
                          document.getElementById(selected_comuna).style.stroke = CONFIG.line_color_selected;
                          document.getElementById(selected_comuna).style.strokeWidth = "10px";
                          div.transition()
                                  .duration(200)
                                  .style("opacity", .9);
                          div.html(e.target.id.replaceAll("_", " "))
                                  .style("left", (e.pageX) + "px")
                                  .style("top", (e.pageY - 28) + "px");
                        })
                        .on("mouseout", function(e){
                          let selected_comuna = e.target.id;
                          document.getElementById(selected_comuna).style.stroke = CONFIG.line_color_unselected;
                          document.getElementById(selected_comuna).style.strokeWidth = "1.41398096px";
                          div.transition()
                                  .duration(500)
                                  .style("opacity", 0);
                        })
                        .on("click", function(e){
                          let selected_comuna = e.target.id;
                          console.log("Click", selected_comuna);
                          addTable(selected_comuna);
                        })
                        .selectAll("path")
                        .style("fill", CONFIG.null_color);
                svg.node().appendChild(svgMap);
                d3.csv(dataset_file).then(data =>{
                  whole_data = data;
                  data = selectIsp(isp, data);
                  console.debug(data);
                  console.debug(data.length);
                  const color = d3.scaleQuantile()
                          .domain([
                                  d3.min(data, function(d){
                                    return d.rtt;
                                  }),
                                  d3.max(data, function(d){
                                    return d.rtt;
                                  })
                                  ])
                          .range(colorScaleRedo(data.length));
                  data.forEach(function(d){
                    d3.select(document.getElementById(d.comuna.replaceAll(" ", "_")))
                            .style("fill", color(+d.rtt));
                  })
                  let scale_height = svgMap.height.animVal.value * 0.8
                  showScale(color, scale_height);
                });
              });
      }

      initialize();

      function colorScaleRedo(k){
        console.debug(`Color scale of ${k} elements`);
        if (k === 4){
          return [CONFIG.color_scale[0], CONFIG.color_scale[1], CONFIG.color_scale[3], CONFIG.color_scale[4]];
        } else if (k === 3){
          return [CONFIG.color_scale[0], CONFIG.color_scale[2], CONFIG.color_scale[4]];
        } else if (k === 2){
          return [CONFIG.color_scale[0], CONFIG.color_scale[4]];
        } else if (k === 1){
          return [CONFIG.color_scale[2]];
        } else {
          return CONFIG.color_scale;
        }
      }

      function addTable(comuna){
        let name_comuna = comuna.replaceAll("_", " ");
        console.debug(`Table of "${name_comuna}"`);
        let is_there = false;
        let table = `<tr><th>ISP</th><th>RTT</th><th>Jitter</th></tr>`
        for (let a in whole_data){
          if (whole_data[a].comuna === name_comuna){
            if (! is_there){
              is_there = true;
            }
            console.debug(whole_data[a]);
            table += `<tr><td>${isp_names[whole_data[a].isp]}</td>`
            table += `<td>${(+whole_data[a].avg_rtt).toFixed(2)}</td>`
            table += `<td>${(+whole_data[a].avg_jitter).toFixed(2)}</td></tr>`
          }
        }
        if (is_there) {
          document.getElementById("table_name").innerHTML = name_comuna;
          document.getElementById("table").style.visibility = "visible";
          document.getElementById("concrete_table").innerHTML = `<table>${table}</table>`;
          console.debug(table);
        } else {
          console.debug(`No data of "${name_comuna}"`);
        }
      }

      function showScale(color_fun,legend_height){
        let domain = color_fun.domain();
        let range = color_fun.range();
        console.debug(domain);
        console.debug(range);
        d3.select("#svg_scale").remove();
        let svg_scale = d3.select("#map_scale")
                .append("svg")
                .attr("id", "svg_scale");
        let bin = (legend_height - 2 * CONFIG.legend_width) / range.length;
        console.debug(`Bin size on legend: ${bin}px`)
        let y = 0;
        svg_scale.append("text")
                .attr("x", CONFIG.legend_width + 5)
                .text(domain[1].toFixed(0));
        for (let a in range) {
          svg_scale.append("rect")
                  .attr("y", y)
                  .style("width", `${CONFIG.legend_width}px`)
                  .style("height", `${bin}px`)
                  .style("fill", range[range.length - a - 1]);
          y += bin;
        }
        svg_scale.append("text")
                .attr("x", CONFIG.legend_width + 5)
                .attr("y", y)
                .text(domain[0].toFixed(0));
        svg_scale.append("rect")
                .attr("y", y + CONFIG.legend_width)
                .style("width", `${CONFIG.legend_width}px`)
                .style("height", `${CONFIG.legend_width}px`)
                .style("fill", CONFIG.null_color);
        svg_scale.append("text")
                .attr("x", CONFIG.legend_width + 5)
                .attr("y", y + 1.5 * CONFIG.legend_width + 5)
                .text("Sin datos");
      }
    </script>
  </body>
</html>
